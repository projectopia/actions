name: Projectopia Core
on:
  workflow_dispatch:
    inputs:
      github-token:
        description: "OAuth github-token"
        required: true
      repository-name:
        description: "Repository Name"
        required: true
        default: "projectopia.example"
      repository-description:
        description: "Repository Description"
        required: false
        default: "A repository generated by Projectopia"
      repository-private:
        description: "Repository Visibility"
        type: choice
        options:
          - public
          - private
        default: public
      template-choice:
        description: "Template choice"
        type: choice
        options:
          - docusaurus
          - mkdocs-material
        default: mkdocs-material
      project-name:
        description: "Project name"
        required: true
      project-tagline:
        description: "Project tagline"
        required: true
      github-username:
        description: "GitHub username"
        required: true
env:
  template-url: https://github.com/projectopia/forge.blog

jobs:
  generator:
    name: Generator
    runs-on: ubuntu-latest
    steps:
      - name: Hide sensitive inputs
        uses: levibostian/action-hide-sensitive-inputs@1.0.0

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install and configure Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: false
          virtualenvs-in-project: false

      - name: Install project modules and dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Setup Git and authenticate
        run: |
          touch ~/.netrc && sudo apt-get update && sudo apt-get install -y git
          git config --global user.name "projectopia-bot"
          git config --global user.email "projectopia.hcmus@outlook.com"
          echo "machine github.com" >> ~/.netrc
          echo "login ${{ inputs.github-username }}" >> ~/.netrc
          echo "password ${{ inputs.github-token }}" >> ~/.netrc

      - name: Create repository using Python Module
        run: |
          python3 -m projectopia.repo.main:run --name "${{ inputs.repository-name }}" --description "${{ inputs.repository-description }}" --private "${{ inputs.repository-private }}" --pages "true" --token "${{ inputs.github-token }}"

      - name: Apply scaffold
        run: |
          git clone https://github.com/${{ inputs.github-username }}/${{ inputs.repository-name }} /tmp/remote-repo
          cruft create ${{ env.template-url }} --directory ${{ inputs.template-choice}}-template --extra-context '{"blog_name": "${{ inputs.project-name }}", "blog_slug": "${{ inputs.repository-name }}", "blog_tagline": "${{ inputs.project-tagline }}", "github_username": "${{ inputs.github-username }}"}' --overwrite-if-exists --output-dir /tmp/generated -y
          cp -rT "/tmp/generated/${{ inputs.repository-name }}" /tmp/remote-repo

      - name: Push changes to a null repository
        run: |
          cd /tmp/remote-repo
          git checkout main
          git add --all
          git commit -m "feat(bot): apply projectopia scaffold"
          git push -u origin main
